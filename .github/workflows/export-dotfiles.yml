name: Export Portable Dotfiles

on:
  workflow_dispatch:

jobs:
  export-portable:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Build Portable Home Configuration
        run: |
          # Build the activation package which contains the home-files link
          nix build ./nix#homeConfigurations.portable.activationPackage

      - name: Prepare Stow Directory
        run: |
          mkdir -p stow
          # Dereference symlinks to get actual file content
          # Copy hidden files and normal files from result/home-files/ to stow/
          # We use '.' to include hidden files
          cp -L -R result/home-files/. stow/
          
          echo "Exported files:"
          ls -R stow/

      - name: Create Archive
        run: |
          tar -czf dotfiles-portable.tar.gz -C stow .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dotfiles-portable
          path: dotfiles-portable.tar.gz
          retention-days: 7
          
      - name: Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          files: dotfiles-portable.tar.gz
          tag_name: portable-${{ github.run_number }}
          name: Portable Dotfiles Export ${{ github.run_number }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
